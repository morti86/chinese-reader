name: Release Windows Build

on:
  push:
    tags:
      - 'v*' # Triggers on tags like v1.0, v1.2.3, etc.
  workflow_dispatch: # Allows manual triggering
    inputs:
      version:
        description: 'Version number (e.g., v1.0.1 or dev-build)'
        required: false
        default: 'dev-manual'
        
permissions:
  contents: write # Required to create a GitHub Release and upload assets

jobs:
  build-windows:
    runs-on: windows-latest

    env:
      # Change this to match your binary name defined in Cargo.toml
      BINARY_NAME: cnreader
      RELEASE_VERSION: ${{ github.ref_name }}
      EXTRA_FILES: "README.md LICENSE models/* app.toml dict.db"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo dependencies
        uses: Swatinem/rust-cache@v2

      - name: Build Release
        run: cargo build --release --verbose

      - name: Prepare Release Folder
        shell: pwsh
        run: |
          # Create a folder to stage the release contents
          New-Item -ItemType Directory -Force -Path "release-build"
          
          # Copy the compiled binary
          Copy-Item "target/release/${{ env.BINARY_NAME }}.exe" -Destination "release-build/"
          
          # Copy extra files from the repo (ignoring errors if files don't exist)
          $files = "${{ env.EXTRA_FILES }}".Split(' ')
          foreach ($file in $files) {
            if (Test-Path $file) {
              Copy-Item $file -Destination "release-build/"
              Write-Host "Copied $file"
            } else {
              Write-Host "Warning: $file not found, skipping..."
            }
          }

          # Create the zip archive
          $zipName = "release-${{ env.RELEASE_VERSION }}.zip"
          Compress-Archive -Path "release-build/*" -DestinationPath $zipName
          
          Write-Host "Created $zipName"
          
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_VERSION }}
          files: "release-${{ env.RELEASE_VERSION }}.zip"
          generate_release_notes: true
          draft: ${{ github.event_name == 'workflow_dispatch' }}
